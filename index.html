<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Shipments - Track Your Package</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS for all pages */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --text-color: #333;
            --text-light: #7f8c8d;
            --border-color: #ddd;
            --sidebar-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .admin-login {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .admin-login:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Tracking form styles */
        .tracking-form {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .tracking-form h2 {
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: var(--secondary-color);
        }

        /* Tracking results */
        .tracking-result {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .package-info h3, .timeline h3 {
            margin-bottom: 20px;
            color: var(--dark-color);
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .label {
            font-weight: 500;
            color: var(--text-light);
            display: block;
            margin-bottom: 5px;
        }

        .value {
            font-size: 18px;
            color: var(--text-color);
        }

        /* Timeline */
        .timeline-steps {
            position: relative;
            padding-left: 50px;
        }

        .timeline-steps::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--primary-color);
        }

        .timeline-step {
            position: relative;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .timeline-step::before {
            content: '';
            position: absolute;
            left: -38px;
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--light-color);
            border: 3px solid var(--primary-color);
        }

        .timeline-step.active::before {
            background-color: var(--primary-color);
        }

        .timeline-step.completed::before {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .timeline-step h4 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .timeline-step p {
            color: var(--text-light);
            font-size: 14px;
        }

        .timeline-step .timeline-date {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Error message */
        .error-message {
            background-color: var(--danger-color);
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        footer {
            text-align: center;
            padding: 20px 0;
            background-color: var(--dark-color);
            color: white;
            margin-top: 50px;
        }

        /* Admin login page */
        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin: 0 auto;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--dark-color);
        }

        /* Admin dashboard styles */
        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100%;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav ul li {
            margin-bottom: 5px;
        }

        .sidebar nav ul li a {
            display: block;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar nav ul li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .sidebar nav ul li.active a {
            background-color: var(--primary-color);
            color: white;
        }

        .logout {
            position: absolute;
            bottom: 20px;
            width: 100%;
            padding: 0 20px;
        }

        .logout a {
            display: block;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .logout a:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            background-color: #f5f7fa;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8f9fa;
            font-weight: 500;
            color: var(--text-light);
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-filter input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        /* Page transitions */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Customer Tracking Page -->
    <div id="tracking-page" class="page active">
        <header>
            <div class="container">
                <h1>Global Shipments</h1>
                <p>Track your international packages from India</p>
                <a href="#" class="admin-login" id="admin-login-link">Admin Login</a>
            </div>
        </header>

        <main class="container">
            <section class="tracking-form">
                <h2>Track Your Shipment</h2>
                <form id="trackingForm">
                    <div class="form-group">
                        <label for="trackingNumber">Enter Tracking Number (GSXXXXXXXX)</label>
                        <input type="text" id="trackingNumber" placeholder="GS00000001" required>
                    </div>
                    <button type="submit" class="btn">Track Package</button>
                </form>
            </section>

            <section class="tracking-result" id="trackingResult" style="display: none;">
                <div class="package-info">
                    <h3>Shipment Details</h3>
                    <div class="info-grid">
                        <div>
                            <span class="label">Tracking Number:</span>
                            <span id="resultTrackingNumber" class="value">-</span>
                        </div>
                        <div>
                            <span class="label">Status:</span>
                            <span id="resultStatus" class="value">-</span>
                        </div>
                        <div>
                            <span class="label">Origin:</span>
                            <span id="resultOrigin" class="value">-</span>
                        </div>
                        <div>
                            <span class="label">Destination:</span>
                            <span id="resultDestination" class="value">-</span>
                        </div>
                        <div>
                            <span class="label">Weight:</span>
                            <span id="resultWeight" class="value">-</span>
                        </div>
                        <div>
                            <span class="label">Last Updated:</span>
                            <span id="resultUpdated" class="value">-</span>
                        </div>
                    </div>
                </div>

                <div class="timeline">
                    <h3>Shipment Progress</h3>
                    <div class="timeline-steps" id="timelineSteps">
                        <!-- Timeline will be populated by JavaScript -->
                    </div>
                </div>
            </section>

            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </main>

        <footer>
            <div class="container">
                <p>&copy; 2023 Global Shipments. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Admin Login Page -->
    <div id="admin-login-page" class="page">
        <div class="login-container">
            <div class="login-box">
                <h1>Admin Login</h1>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <div id="loginError" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard-page" class="page">
        <div class="admin-container">
            <aside class="sidebar">
                <div class="logo">Global Shipments</div>
                <nav>
                    <ul>
                        <li class="active"><a href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li><a href="#create-shipment"><i class="fas fa-plus-circle"></i> Create Shipment</a></li>
                        <li><a href="#manage-shipments"><i class="fas fa-boxes"></i> Manage Shipments</a></li>
                    </ul>
                </nav>
                <div class="logout">
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </aside>

            <main class="main-content">
                <header class="admin-header">
                    <h1>Admin Dashboard</h1>
                    <div class="user-info">
                        <span id="adminEmail"></span>
                    </div>
                </header>

                <section id="dashboard" class="dashboard-section">
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3>Total Shipments</h3>
                            <p id="totalShipments">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>In Transit</h3>
                            <p id="inTransit">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Delivered</h3>
                            <p id="delivered">0</p>
                        </div>
                    </div>

                    <div class="recent-shipments">
                        <h2>Recent Shipments</h2>
                        <table id="recentShipmentsTable">
                            <thead>
                                <tr>
                                    <th>Tracking #</th>
                                    <th>Status</th>
                                    <th>Destination</th>
                                    <th>Last Update</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="create-shipment" class="create-shipment-section" style="display: none;">
                    <h2>Create New Shipment</h2>
                    <form id="createShipmentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName">Customer Name</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerEmail">Customer Email</label>
                                <input type="email" id="customerEmail">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="origin">Origin (India)</label>
                                <input type="text" id="origin" value="Mumbai, India" required>
                            </div>
                            <div class="form-group">
                                <label for="destination">Destination</label>
                                <input type="text" id="destination" placeholder="New York, USA" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="weight">Weight (kg)</label>
                                <input type="number" id="weight" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="dimensions">Dimensions (LxWxH in cm)</label>
                                <input type="text" id="dimensions" placeholder="30x20x15">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="contents">Package Contents</label>
                            <textarea id="contents" rows="3"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">Create Shipment</button>
                    </form>
                </section>

                <section id="manage-shipments" class="manage-shipments-section" style="display: none;">
                    <h2>Manage Shipments</h2>
                    <div class="search-filter">
                        <input type="text" id="shipmentSearch" placeholder="Search by tracking number...">
                        <select id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="Shipment Created">Shipment Created</option>
                            <option value="Shipped from India">Shipped from India</option>
                            <option value="In Transit">In Transit</option>
                            <option value="Reached Destination Country">Reached Destination Country</option>
                            <option value="In Local Facility">In Local Facility</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                        </select>
                    </div>

                    <table id="shipmentsTable">
                        <thead>
                            <tr>
                                <th>Tracking #</th>
                                <th>Customer</th>
                                <th>Destination</th>
                                <th>Status</th>
                                <th>Last Update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </section>

                <!-- Edit Shipment Modal -->
                <div id="editShipmentModal" class="modal">
                    <div class="modal-content">
                        <span class="close-modal">&times;</span>
                        <h2>Update Shipment Status</h2>
                        <form id="editShipmentForm">
                            <input type="hidden" id="editTrackingNumber">
                            
                            <div class="form-group">
                                <label for="editStatus">Status</label>
                                <select id="editStatus" required>
                                    <option value="Shipment Created">Shipment Created</option>
                                    <option value="Shipped from India">Shipped from India</option>
                                    <option value="In Transit">In Transit</option>
                                    <option value="Reached Destination Country">Reached Destination Country</option>
                                    <option value="In Local Facility">In Local Facility</option>
                                    <option value="Out for Delivery">Out for Delivery</option>
                                    <option value="Delivered">Delivered</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="editLocation">Current Location</label>
                                <input type="text" id="editLocation" required>
                            </div>

                            <div class="form-group">
                                <label for="editNotes">Notes (Visible to Customer)</label>
                                <textarea id="editNotes" rows="3"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">Update Shipment</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDK (version 9 modular) -->
    <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
    getFirestore, collection, doc, setDoc, getDoc, updateDoc, 
    arrayUnion, query, where, orderBy, limit, getDocs, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { 
    getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyAIMQbZZjIb-Z_sNJ4_7XhNz0DtiNnSSfg",
    authDomain: "shipment-bec8d.firebaseapp.com",
    projectId: "shipment-bec8d",
    storageBucket: "shipment-bec8d.appspot.com",
    messagingSenderId: "83538524138",
    appId: "1:83538524138:web:c06cf1b00915ea1f606493",
    measurementId: "G-XHDE3ZMCEY"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Status order for timeline
const statusOrder = [
    "Shipment Created",
    "Shipped from India",
    "In Transit",
    "Reached Destination Country",
    "In Local Facility",
    "Out for Delivery",
    "Delivered"
];

// Page management
const pages = {
    'tracking': document.getElementById('tracking-page'),
    'admin-login': document.getElementById('admin-login-page'),
    'admin-dashboard': document.getElementById('admin-dashboard-page')
};

function showPage(pageId) {
    Object.values(pages).forEach(page => page.classList.remove('active'));
    pages[pageId].classList.add('active');
}

// Navigation
document.getElementById('admin-login-link')?.addEventListener('click', (e) => {
    e.preventDefault();
    showPage('admin-login');
});

// Check initial auth state
onAuthStateChanged(auth, (user) => {
    if (user && user.email.toLowerCase() === 'admin@gantasolutions.com') {
        showPage('admin-dashboard');
        initAdminDashboard();
    } else if (window.location.hash === '#admin') {
        showPage('admin-login');
    } else {
        showPage('tracking');
        initTrackingPage();
    }
});

// Tracking Page Functionality
function initTrackingPage() {
    const trackingForm = document.getElementById('trackingForm');
    const trackingResult = document.getElementById('trackingResult');
    const errorMessage = document.getElementById('errorMessage');
    
    if (trackingForm) {
        trackingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const trackingNumber = document.getElementById('trackingNumber').value.trim();
            
            if (!trackingNumber.startsWith('GS') || trackingNumber.length !== 10) {
                showError('Please enter a valid tracking number starting with GS followed by 8 digits.');
                return;
            }
            
            try {
                // Check Firestore for this tracking number
                const docRef = doc(db, 'shipments', trackingNumber);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    displayShipmentDetails(docSnap.data());
                } else {
                    showError('No shipment found with this tracking number. Please check and try again.');
                }
            } catch (error) {
                console.error("Error getting shipment: ", error);
                showError('An error occurred while fetching shipment details. Please try again later.');
            }
        });
    }
    
    function displayShipmentDetails(shipment) {
        // Update the main info section
        document.getElementById('resultTrackingNumber').textContent = shipment.trackingNumber;
        document.getElementById('resultStatus').textContent = shipment.status;
        document.getElementById('resultOrigin').textContent = shipment.origin;
        document.getElementById('resultDestination').textContent = shipment.destination;
        document.getElementById('resultWeight').textContent = shipment.weight ? `${shipment.weight} kg` : '-';
        document.getElementById('resultUpdated').textContent = formatDate(shipment.updatedAt.toDate());
        
        // Update the timeline
        const timelineSteps = document.getElementById('timelineSteps');
        timelineSteps.innerHTML = '';
        
        let currentStatusIndex = statusOrder.indexOf(shipment.status);
        
        statusOrder.forEach((status, index) => {
            const step = document.createElement('div');
            step.className = 'timeline-step';
            
            if (index < currentStatusIndex) {
                step.classList.add('completed');
            } else if (index === currentStatusIndex) {
                step.classList.add('active');
            }
            
            const statusTitle = document.createElement('h4');
            statusTitle.textContent = status;
            
            const statusDesc = document.createElement('p');
            if (index < currentStatusIndex) {
                // For completed steps, show when it happened
                const historyItem = shipment.history.find(item => item.status === status);
                if (historyItem) {
                    statusDesc.textContent = historyItem.notes || 'Status updated';
                    const dateElement = document.createElement('span');
                    dateElement.className = 'timeline-date';
                    dateElement.textContent = formatDate(historyItem.timestamp.toDate());
                    step.appendChild(dateElement);
                }
            } else if (index === currentStatusIndex) {
                // For current step, show latest notes
                statusDesc.textContent = shipment.notes || 'Current status';
            } else {
                // For future steps, just show the status name
                statusDesc.textContent = 'Pending';
            }
            
            step.appendChild(statusTitle);
            step.appendChild(statusDesc);
            timelineSteps.appendChild(step);
        });
        
        // Hide error message if it was shown
        errorMessage.style.display = 'none';
        
        // Show the tracking result
        trackingResult.style.display = 'block';
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        trackingResult.style.display = 'none';
    }
}

// Admin Login Page Functionality
const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');

if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        try {
            // Show loading state
            loginError.textContent = 'Logging in...';
            loginError.style.color = 'blue';
            loginError.style.display = 'block';
            
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            
            // Check if the email is the admin email (case insensitive)
            if (userCredential.user.email.toLowerCase() !== 'admin@gantasolutions.com') {
                await signOut(auth);
                loginError.textContent = 'Only admin can access this panel';
                loginError.style.color = 'red';
                return;
            }
            
            showPage('admin-dashboard');
            initAdminDashboard();
        } catch (error) {
            console.error('Login error:', error);
            
            // More specific error messages
            if (error.code === 'auth/user-not-found') {
                loginError.textContent = 'User not found. Please check your email.';
            } else if (error.code === 'auth/wrong-password') {
                loginError.textContent = 'Incorrect password. Please try again.';
            } else if (error.code === 'auth/invalid-email') {
                loginError.textContent = 'Invalid email format.';
            } else {
                loginError.textContent = 'Login failed: ' + error.message;
            }
            
            loginError.style.color = 'red';
        }
    });
}

// Admin Dashboard Functionality
function initAdminDashboard() {
    document.getElementById('adminEmail').textContent = auth.currentUser.email;
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        signOut(auth).then(() => {
            showPage('tracking');
            window.location.hash = '';
        });
    });
    
    // Navigation links
    document.querySelectorAll('nav ul li a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all links
            document.querySelectorAll('nav ul li').forEach(li => {
                li.classList.remove('active');
            });
            
            // Add active class to clicked link
            this.parentElement.classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('.main-content > section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the selected section
            const sectionId = this.getAttribute('href').substring(1);
            document.getElementById(sectionId).style.display = 'block';
        });
    });
    
    // Modal close button
    document.querySelector('.close-modal').addEventListener('click', () => {
        document.getElementById('editShipmentModal').style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === document.getElementById('editShipmentModal')) {
            document.getElementById('editShipmentModal').style.display = 'none';
        }
    });
    
    // Setup event listeners
    setupEventListeners();
    loadDashboard();
}

function setupEventListeners() {
    // Create shipment form
    const createShipmentForm = document.getElementById('createShipmentForm');
    if (createShipmentForm) {
        createShipmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await createNewShipment();
        });
    }
    
    // Edit shipment form
    const editShipmentForm = document.getElementById('editShipmentForm');
    if (editShipmentForm) {
        editShipmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await updateShipment();
        });
    }
    
    // Search and filter
    const shipmentSearch = document.getElementById('shipmentSearch');
    if (shipmentSearch) {
        shipmentSearch.addEventListener('input', () => {
            filterShipments();
        });
    }
    
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', () => {
            filterShipments();
        });
    }
}

async function loadDashboard() {
    try {
        // Load stats
        const shipmentsQuery = query(collection(db, 'shipments'));
        const shipmentsSnapshot = await getDocs(shipmentsQuery);
        
        const totalShipments = shipmentsSnapshot.size;
        let inTransit = 0;
        let delivered = 0;
        
        shipmentsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === 'Delivered') {
                delivered++;
            } else {
                inTransit++;
            }
        });
        
        document.getElementById('totalShipments').textContent = totalShipments;
        document.getElementById('inTransit').textContent = inTransit;
        document.getElementById('delivered').textContent = delivered;
        
        // Load recent shipments
        const recentQuery = query(
            collection(db, 'shipments'),
            orderBy('createdAt', 'desc'),
            limit(5)
        );
        const recentSnapshot = await getDocs(recentQuery);
        
        const tableBody = document.querySelector('#recentShipmentsTable tbody');
        if (tableBody) {
            tableBody.innerHTML = '';
            
            recentSnapshot.forEach(doc => {
                const data = doc.data();
                const row = createShipmentTableRow(data);
                tableBody.appendChild(row);
            });
        }
        
        // Load all shipments for management
        await loadAllShipments();
    } catch (error) {
        console.error('Error loading dashboard:', error);
    }
}

async function loadAllShipments() {
    try {
        const allQuery = query(
            collection(db, 'shipments'),
            orderBy('createdAt', 'desc')
        );
        const allSnapshot = await getDocs(allQuery);
        
        const tableBody = document.querySelector('#shipmentsTable tbody');
        if (tableBody) {
            tableBody.innerHTML = '';
            
            allSnapshot.forEach(doc => {
                const data = doc.data();
                const row = createShipmentTableRow(data, true);
                tableBody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading shipments:', error);
    }
}

function createShipmentTableRow(data, withActions = false) {
    const row = document.createElement('tr');
    
    // Tracking Number
    const trackingCell = document.createElement('td');
    trackingCell.textContent = data.trackingNumber;
    row.appendChild(trackingCell);
    
    // Customer (or Status for recent shipments)
    const customerCell = document.createElement('td');
    if (withActions) {
        customerCell.textContent = data.customerName || '-';
    } else {
        customerCell.textContent = data.status;
    }
    row.appendChild(customerCell);
    
    // Destination
    const destinationCell = document.createElement('td');
    destinationCell.textContent = data.destination;
    row.appendChild(destinationCell);
    
    // Status (only for management table)
    if (withActions) {
        const statusCell = document.createElement('td');
        statusCell.textContent = data.status;
        row.appendChild(statusCell);
    }
    
    // Last Updated
    const updatedCell = document.createElement('td');
    updatedCell.textContent = formatDate(data.updatedAt.toDate());
    row.appendChild(updatedCell);
    
    // Actions (only for management table)
    if (withActions) {
        const actionsCell = document.createElement('td');
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-primary btn-sm';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', () => openEditModal(data));
        actionsCell.appendChild(editBtn);
        
        row.appendChild(actionsCell);
    }
    
    return row;
}

function openEditModal(shipment) {
    const modal = document.getElementById('editShipmentModal');
    const form = document.getElementById('editShipmentForm');
    
    document.getElementById('editTrackingNumber').value = shipment.trackingNumber;
    document.getElementById('editStatus').value = shipment.status;
    document.getElementById('editLocation').value = shipment.currentLocation || '';
    document.getElementById('editNotes').value = shipment.notes || '';
    
    modal.style.display = 'flex';
}

async function createNewShipment() {
    try {
        // Get the current count
        const counterRef = doc(db, 'counters', 'shipments');
        const counterDoc = await getDoc(counterRef);
        
        let count = 1;
        if (counterDoc.exists()) {
            count = counterDoc.data().count + 1;
        }
        
        const trackingNumber = 'GS' + count.toString().padStart(8, '0');
        
        // Create the shipment
        const now = new Date();
        const shipment = {
            trackingNumber: trackingNumber,
            customerName: document.getElementById('customerName').value,
            customerEmail: document.getElementById('customerEmail').value,
            origin: document.getElementById('origin').value,
            destination: document.getElementById('destination').value,
            weight: parseFloat(document.getElementById('weight').value),
            dimensions: document.getElementById('dimensions').value,
            contents: document.getElementById('contents').value,
            status: 'Shipment Created',
            currentLocation: document.getElementById('origin').value,
            notes: 'Shipment created and ready for processing',
            createdAt: now,
            updatedAt: now,
            history: [{
                status: 'Shipment Created',
                notes: 'Shipment created and ready for processing',
                location: document.getElementById('origin').value,
                timestamp: now
            }]
        };
        
        // Add to Firestore
        await setDoc(doc(db, 'shipments', trackingNumber), shipment);
        
        // Update counter
        await setDoc(counterRef, { count: count });
        
        alert(`Shipment created successfully! Tracking Number: ${trackingNumber}`);
        document.getElementById('createShipmentForm').reset();
        await loadDashboard();
    } catch (error) {
        console.error("Error creating shipment: ", error);
        alert('Error creating shipment. Please try again.');
    }
}

async function updateShipment() {
    try {
        const trackingNumber = document.getElementById('editTrackingNumber').value;
        const status = document.getElementById('editStatus').value;
        const location = document.getElementById('editLocation').value;
        const notes = document.getElementById('editNotes').value;
        
        const now = new Date();
        const historyUpdate = {
            status: status,
            notes: notes,
            location: location,
            timestamp: now
        };
        
        // Update the shipment
        await updateDoc(doc(db, 'shipments', trackingNumber), {
            status: status,
            currentLocation: location,
            notes: notes,
            updatedAt: now,
            history: arrayUnion(historyUpdate)
        });
        
        alert('Shipment updated successfully!');
        document.getElementById('editShipmentModal').style.display = 'none';
        await loadDashboard();
    } catch (error) {
        console.error("Error updating shipment: ", error);
        alert('Error updating shipment. Please try again.');
    }
}

async function filterShipments() {
    try {
        const searchText = document.getElementById('shipmentSearch').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        
        let shipmentsQuery;
        if (statusFilter) {
            shipmentsQuery = query(
                collection(db, 'shipments'),
                where('status', '==', statusFilter),
                orderBy('createdAt', 'desc')
            );
        } else {
            shipmentsQuery = query(
                collection(db, 'shipments'),
                orderBy('createdAt', 'desc')
            );
        }
        
        const shipmentsSnapshot = await getDocs(shipmentsQuery);
        const tableBody = document.querySelector('#shipmentsTable tbody');
        if (tableBody) {
            tableBody.innerHTML = '';
            
            shipmentsSnapshot.forEach(doc => {
                const data = doc.data();
                
                // Apply search filter
                if (searchText && !data.trackingNumber.toLowerCase().includes(searchText)) {
                    return;
                }
                
                const row = createShipmentTableRow(data, true);
                tableBody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error filtering shipments:', error);
    }
}

function formatDate(date) {
    const options = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    return date.toLocaleDateString('en-US', options);
}

// Initialize the appropriate page based on current state
if (window.location.hash === '#admin') {
    showPage('admin-login');
} else {
    showPage('tracking');
    initTrackingPage();
}
    </script>
</body>
</html>
