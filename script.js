const firebaseConfig={apiKey:"AIzaSyAIMQbZZjIb-Z_sNJ4_7XhNz0DtiNnSSfg",authDomain:"shipment-bec8d.firebaseapp.com",projectId:"shipment-bec8d",storageBucket:"shipment-bec8d.appspot.com",messagingSenderId:"83538524138",appId:"1:83538524138:web:c06cf1b00915ea1f606493",measurementId:"G-XHDE3ZMCEY"};const app=initializeApp(firebaseConfig);const db=getFirestore(app);const auth=getAuth(app);const statusOrder=["Shipment Created","Shipped from India","In Transit","Reached Destination Country","In Local Facility","Out for Delivery","Delivered"];const statusIcons={"Shipment Created":"fas fa-box","Shipped from India":"fas fa-ship","In Transit":"fas fa-plane","Reached Destination Country":"fas fa-flag-checkered","In Local Facility":"fas fa-warehouse","Out for Delivery":"fas fa-truck","Delivered":"fas fa-check-circle"};const statusBadges={"Shipment Created":"status-created","Shipped from India":"status-shipped","In Transit":"status-transit","Reached Destination Country":"status-arrived","In Local Facility":"status-arrived","Out for Delivery":"status-delivery","Delivered":"status-delivered"};const pages={'tracking':document.getElementById('tracking-page'),'admin-login':document.getElementById('admin-login-page'),'admin-dashboard':document.getElementById('admin-dashboard-page')};const allowedAdminEmails=['admin@gantasolutions.com','srasthainternationalcouriers@gmail.com'];function showPage(e){Object.values(pages).forEach(t=>{t&&t.classList.remove('active')});pages[e]&&pages[e].classList.add('active')}function showLoading(){const e=document.getElementById('loadingSpinner'),t=document.getElementById('trackingResult'),n=document.getElementById('errorMessage');e&&(e.style.display='block'),t&&(t.style.display='none'),n&&(n.style.display='none')}function hideLoading(){const e=document.getElementById('loadingSpinner');e&&(e.style.display='none')}window.location.hash==='#admin'?showPage('admin-login'):(showPage('tracking'),initTrackingPage());function initTrackingPage(){const e=document.getElementById('trackingForm'),t=document.getElementById('trackingResult'),n=document.getElementById('errorMessage'),o=document.getElementById('errorText');e&&e.addEventListener('submit',async function(e){e.preventDefault();const n=document.getElementById('trackingNumber').value.trim().toUpperCase();if(!n.startsWith('SIC')||11!==n.length)return void showError('Please enter a valid tracking number starting with SIC followed by 8 characters (e.g., SIC00000001).');try{showLoading();const e=doc(db,'shipments',n),t=await getDoc(e);hideLoading(),t.exists()?displayShipmentDetails(t.data()):showError('No shipment found with this tracking number. Please check and try again.')}catch(e){hideLoading(),console.error("Error getting shipment: ",e),showError('An error occurred while fetching shipment details. Please try again later.')}});function displayShipmentDetails(e){document.getElementById('resultTrackingNumber').textContent=e.trackingNumber;const t=document.getElementById('resultStatus');t.textContent=e.status,t.className='value';const n=statusBadges[e.status]||'status-created';t.innerHTML=`${e.status} <span class="status-badge ${n}">${e.status}</span>`,document.getElementById('resultOrigin').textContent=e.origin,document.getElementById('resultDestination').textContent=e.destination,document.getElementById('resultWeight').textContent=e.weight?`${e.weight} kg`:'-',document.getElementById('resultUpdated').textContent=formatDate(e.updatedAt.toDate());const o=document.getElementById('timelineSteps');o.innerHTML='';let i=statusOrder.indexOf(e.status);statusOrder.forEach((e,s)=>{const a=document.createElement('div');a.className='timeline-step',s<i?a.classList.add('completed'):s===i&&a.classList.add('active');const l=document.createElement('h4'),c=document.createElement('i');c.className=statusIcons[e]||'fas fa-circle',l.appendChild(c),l.appendChild(document.createTextNode(e));const d=document.createElement('p');if(s<i){const t=e.history.find(t=>t.status===e);t&&(d.textContent=t.notes||'Status updated',r=document.createElement('span'),r.className='timeline-date',i=document.createElement('i'),i.className='far fa-clock',r.appendChild(i),r.appendChild(document.createTextNode(formatDate(t.timestamp.toDate())),a.appendChild(r)}else s===i?d.textContent=e.notes||'Current status':d.textContent='Pending';a.appendChild(l),a.appendChild(d),o.appendChild(a);var r,i})}function showError(e){o.textContent=e,n.style.display='flex',t.style.display='none'}}const loginForm=document.getElementById('loginForm'),loginError=document.getElementById('loginError');loginForm&&loginForm.addEventListener('submit',async e=>{e.preventDefault();const t=document.getElementById('email').value,n=document.getElementById('password').value;if(!allowedAdminEmails.includes(t.toLowerCase()))return loginError.textContent='Access Denied: Only authorized administrators can log in.',loginError.style.color='red',void(loginError.style.display='block');try{loginError.textContent='Logging in...',loginError.style.color='blue',loginError.style.display='block',await signInWithEmailAndPassword(auth,t,n)}catch(e){console.error('Login error:',e),loginError.textContent=e.code==='auth/user-not-found'?'Admin not found. Please check your email.':e.code==='auth/wrong-password'?'Incorrect password. Please try again.':e.code==='auth/invalid-email'?'Invalid email format.':'Login failed: '+e.message,loginError.style.color='red'}});function initAdminDashboard(){document.getElementById('adminEmail').textContent=auth.currentUser.email,document.getElementById('logoutBtn').addEventListener('click',e=>{e.preventDefault(),signOut(auth).then(()=>{showPage('tracking'),window.location.hash=''})}),document.querySelectorAll('nav ul li a').forEach(e=>{e.addEventListener('click',function(e){e.preventDefault(),document.querySelectorAll('nav ul li').forEach(e=>{e.classList.remove('active')}),this.parentElement.classList.add('active'),document.querySelectorAll('.main-content > section').forEach(e=>{e.style.display='none'});const t=this.getAttribute('href').substring(1);document.getElementById(t).style.display='block'})}),document.querySelector('.close-modal').addEventListener('click',()=>{document.getElementById('editShipmentModal').style.display='none'}),window.addEventListener('click',e=>{e.target===document.getElementById('editShipmentModal')&&(document.getElementById('editShipmentModal').style.display='none')}),setupEventListeners(),loadDashboard()}function setupEventListeners(){const e=document.getElementById('createShipmentForm');e&&e.addEventListener('submit',async e=>{e.preventDefault(),await createNewShipment()});const t=document.getElementById('editShipmentForm');t&&t.addEventListener('submit',async e=>{e.preventDefault(),await updateShipment()});const n=document.getElementById('shipmentSearch');n&&n.addEventListener('input',()=>{filterShipments()});const o=document.getElementById('statusFilter');o&&o.addEventListener('change',()=>{filterShipments()})}async function loadDashboard(){try{const e=query(collection(db,'shipments')),t=await getDocs(e),n=t.size;let o=0,i=0;t.forEach(e=>{const t=e.data();'Delivered'===t.status?i++:o++}),document.getElementById('totalShipments').textContent=n,document.getElementById('inTransit').textContent=o,document.getElementById('delivered').textContent=i;const s=query(collection(db,'shipments'),orderBy('createdAt','desc'),limit(5)),a=await getDocs(s),l=document.querySelector('#recentShipmentsTable tbody');if(l){l.innerHTML='',a.forEach(e=>{const t=e.data(),n=createShipmentTableRow(t);l.appendChild(n)})}await loadAllShipments()}catch(e){console.error('Error loading dashboard:',e)}}async function loadAllShipments(){try{const e=query(collection(db,'shipments'),orderBy('createdAt','desc')),t=await getDocs(e),n=document.querySelector('#shipmentsTable tbody');if(n){n.innerHTML='',t.forEach(e=>{const t=e.data(),o=createShipmentTableRow(t,!0);n.appendChild(o)})}}catch(e){console.error('Error loading shipments:',e)}}function createShipmentTableRow(e,t=!1){const n=document.createElement('tr'),o=document.createElement('td');o.textContent=e.trackingNumber,n.appendChild(o);const i=document.createElement('td');t?i.textContent=e.customerName||'-':i.textContent=e.status,n.appendChild(i);const s=document.createElement('td');s.textContent=e.destination,n.appendChild(s);if(t){const t=document.createElement('td'),o=statusBadges[e.status]||'status-created';t.innerHTML=`<span class="status-badge ${o}">${e.status}</span>`,n.appendChild(t)}const a=document.createElement('td');a.textContent=formatDate(e.updatedAt.toDate()),n.appendChild(a);if(t){const e=document.createElement('td'),t=document.createElement('button');t.className='btn btn-primary btn-sm',t.innerHTML='<i class="fas fa-edit"></i> Edit',t.addEventListener('click',()=>openEditModal(e)),e.appendChild(t),n.appendChild(e)}return n}function openEditModal(e){const t=document.getElementById('editShipmentModal'),n=document.getElementById('editShipmentForm');document.getElementById('editTrackingNumber').value=e.trackingNumber,document.getElementById('editStatus').value=e.status,document.getElementById('editLocation').value=e.currentLocation||'',document.getElementById('editNotes').value=e.notes||'',t.style.display='flex'}async function createNewShipment(){try{const e=auth.currentUser;if(!e)return void alert('You must be logged in to create a shipment');const t='SIC'+Math.random().toString(36).substr(2,8).toUpperCase(),n=new Date,o={trackingNumber:t,customerId:e.uid,customerName:document.getElementById('customerName').value,customerEmail:document.getElementById('customerEmail').value,origin:document.getElementById('origin').value,destination:document.getElementById('destination').value,weight:parseFloat(document.getElementById('weight').value),dimensions:document.getElementById('dimensions').value,contents:document.getElementById('contents').value,status:'Shipment Created',currentLocation:document.getElementById('origin').value,notes:'Shipment created and ready for processing',createdAt:n,updatedAt:n,history:[{status:'Shipment Created',notes:'Shipment created and ready for processing',location:document.getElementById('origin').value,timestamp:n}]};await setDoc(doc(db,'shipments',t),alert(`Shipment created successfully! Tracking Number: ${t}`),document.getElementById('createShipmentForm').reset(),await loadDashboard()}catch(e){console.error("Error creating shipment: ",e),alert('Error creating shipment. Please try again.')}}async function updateShipment(){try{const e=document.getElementById('editTrackingNumber').value,t=document.getElementById('editStatus').value,n=document.getElementById('editLocation').value,o=document.getElementById('editNotes').value,i=new Date,s={status:t,notes:o,location:n,timestamp:i};await updateDoc(doc(db,'shipments',e),{status:t,currentLocation:n,notes:o,updatedAt:i,history:arrayUnion(s)}),alert('Shipment updated successfully!'),document.getElementById('editShipmentModal').style.display='none',await loadDashboard()}catch(e){console.error("Error updating shipment: ",e),alert('Error updating shipment. Please try again.')}}async function filterShipments(){try{const e=document.getElementById('shipmentSearch').value.toLowerCase(),t=document.getElementById('statusFilter').value;let n;n=t?query(collection(db,'shipments'),where('status','==',t),orderBy('createdAt','desc')):query(collection(db,'shipments'),orderBy('createdAt','desc'));const o=await getDocs(n),i=document.querySelector('#shipmentsTable tbody');if(i){i.innerHTML='',o.forEach(t=>{const n=t.data();e&&!n.trackingNumber.toLowerCase().includes(e)||i.appendChild(createShipmentTableRow(n,!0))})}}catch(e){console.error('Error filtering shipments:',e)}}function formatDate(e){const t={year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'};return e.toLocaleDateString('en-US',t)}onAuthStateChanged(auth,e=>{if(e)allowedAdminEmails.includes(e.email.toLowerCase())?(showPage('admin-dashboard'),initAdminDashboard()):signOut(auth).then(()=>{showPage('tracking'),alert('Access Denied: Only authorized administrators can access this panel.'));else window.location.hash==='#admin'?showPage('admin-login'):(showPage('tracking'),initTrackingPage())});
